#' @title Emissions post-processsing 
#'
#' @description Aggregate emissions generated by emis function by time, 
#' vehicle type and segment link (spatial)
#'
#' @param data Data.table; Data.table with emissions and departure_time data.
#' @param emi Character; Columns names of emissions information.
#' @param time_class Character; Emission can be aggregated into 'hour' and'hour-minute'. 
#'  Missing input (Default) no aggregation without considering time consideration.
#' @param time_column Vector; Vector containing 'departure_time'. 
#'  Only used when 'hour' or 'hour-minute' is selected. 
#' @return Units (in g); emissions
#' @export
emis_post <- function(data,emi,time_class,time_column = 'departure_time'){
  
  # data = spo_gpslines
  # emi = c('BR_CO_total','EU_CO_total') # check better names
  # time_class = "hour"
  # time_column = 'departure_time'
  # 
  # check input consistency----
  
  # to data tabke
  data <- data.table::setDT(data)
  
  if(missing(data)) stop("'data' parameter is missing, without default")
  if(missing(emi)) stop("'emi' parameter is missing, without default")
  
  # departure time
  if(missing(time_column) && colnames(data) %nin% 'departure_time'){
    stop(" 'departure_time' is missing without association to 'data' input.")
  }
  if(missing(time_column) && colnames(data) %in% 'departure_time'){
    message(" 'departure_time' is selected from 'data' input.")
  }

  # check emis class
  
  lapply(seq_along(emi),function(i){ # i = 2
    temp_emi <- data[,.SD,.SDcols = emi[i]]
    if(class(temp_emi[[1]]) != "units"){
      stop("emi neeeds to has class 'units'. Please, check package 'units'")
    }
    if(units(temp_emi[[1]])$numerator != "g" & units(temp_emi[[1]])$numerator != "kg"){
      stop("emi needs to has 'units' in 'g' or 'kg'.")
    }
  })
  
  # time - filter
  temp_data <- data[,.SD,.SDcols = c(emi,time_column)]
  temp_data <- temp_data[,departure_time := data.table::as.ITime(departure_time)][order(departure_time),]
  
  if(missing(time_column) == FALSE){
    if(missing(time_class)){stop("Please provide 'time_class' data.")}
    
    # 'hour' time stamp
    
    if(time_class == "hour"){
      temp_data[,departure_time := data.table::hour(departure_time)]
      temp_data <- temp_data[ , lapply(.SD, sum), .SDcols = !"departure_time", by = "departure_time"]
    }
    
    # 'hour-minute' time stamp
    
    if(time_class == "hour-minute"){
      temp_data[,departure_time := paste0(data.table::hour(departure_time),":",
                          data.table::minute(departure_time))]

      temp_data <- temp_data[ , lapply(.SD, sum), .SDcols = !"departure_time", by = "departure_time"]
    }
    return(temp_data)
  }else{
    return(temp_data)
  }
}
