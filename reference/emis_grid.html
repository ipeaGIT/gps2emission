<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Spatial aggregation of emission estimates into a grid — emis_grid • gtfs2emis</title><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial aggregation of emission estimates into a grid — emis_grid"><meta name="description" content="Aggregate emissions proportionally in an sf polygon grid, by performing an
intersection operation between emissions data in sf linestring format and
the input grid cells. User can also aggregate the emissions in the grid
by time of the day."><meta property="og:description" content="Aggregate emissions proportionally in an sf polygon grid, by performing an
intersection operation between emissions data in sf linestring format and
the input grid cells. User can also aggregate the emissions in the grid
by time of the day."><meta property="og:image" content="https://ipeagit.github.io/gtfs2emis/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gtfs2emis</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/gtfs2emis_emission_factor.html">Exploring Emission Factors</a></li>
    <li><a class="dropdown-item" href="../articles/gtfs2emis_fleet_data.html">Preparing fleet data for gtfs2emis</a></li>
    <li><a class="dropdown-item" href="../articles/gtfs2emis_intro_vignette.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/gtfs2emis_non_exhaust_ef.html">Exploring Non-Exhaust Emission Factors</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ipeaGIT/gtfs2emis/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Spatial aggregation of emission estimates into a grid</h1>
      <small class="dont-index">Source: <a href="https://github.com/ipeaGIT/gtfs2emis/blob/master/R/emis_grid.R" class="external-link"><code>R/emis_grid.R</code></a></small>
      <div class="d-none name"><code>emis_grid.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Aggregate emissions proportionally in an sf polygon grid, by performing an
intersection operation between emissions data in <code>sf linestring</code> format and
the input grid cells. User can also aggregate the emissions in the grid
by time of the day.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">emis_grid</span><span class="op">(</span></span>
<span>  <span class="va">emi_list</span>,</span>
<span>  <span class="va">grid</span>,</span>
<span>  time_resolution <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  aggregate <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-emi-list">emi_list<a class="anchor" aria-label="anchor" href="#arg-emi-list"></a></dt>
<dd><p>list. A list containing the data of emissions 'emi'
("data.frame" class) and the transport model 'tp_model' ("sf"
"data.frame" classes).</p></dd>


<dt id="arg-grid">grid<a class="anchor" aria-label="anchor" href="#arg-grid"></a></dt>
<dd><p>Sf polygon. Grid cell data to allocate emissions.</p></dd>


<dt id="arg-time-resolution">time_resolution<a class="anchor" aria-label="anchor" href="#arg-time-resolution"></a></dt>
<dd><p>character. Time resolution in which the emissions is
aggregated. Options are 'hour', 'minute', or 'day (Default).</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p>logical. User can print the total emissions before and after the
intersection operation in order to check if the gridded emissions were
estimated correctly. Default is 'TRUE'.</p></dd>


<dt id="arg-aggregate">aggregate<a class="anchor" aria-label="anchor" href="#arg-aggregate"></a></dt>
<dd><p>logical. Aggregate emissions by pollutant. Default is <code>FALSE</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An <code>"sf" "data.frame"</code> object with emissions estimates per grid cell.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other emission analysis:
<code><a href="emis_summary.html">emis_summary</a>()</code>,
<code><a href="emis_to_dt.html">emis_to_dt</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"gtfstools"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># read GTFS</span></span></span>
<span class="r-in"><span><span class="va">gtfs_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/bra_cur_gtfs.zip"</span>, package <span class="op">=</span> <span class="st">"gtfs2emis"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu">gtfstools</span><span class="fu">::</span><span class="fu"><a href="https://ipeagit.github.io/gtfstools/reference/read_gtfs.html" class="external-link">read_gtfs</a></span><span class="op">(</span><span class="va">gtfs_file</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># keep a single trip_id to speed up this example</span></span></span>
<span class="r-in"><span><span class="va">gtfs_small</span> <span class="op">&lt;-</span> <span class="fu">gtfstools</span><span class="fu">::</span><span class="fu"><a href="https://ipeagit.github.io/gtfstools/reference/filter_by_trip_id.html" class="external-link">filter_by_trip_id</a></span><span class="op">(</span><span class="va">gtfs</span>, trip_id <span class="op">=</span><span class="st">"4451136"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span><span class="co"># run transport model</span></span></span>
<span class="r-in"><span><span class="va">tp_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="transport_model.html">transport_model</a></span><span class="op">(</span>gtfs_data <span class="op">=</span> <span class="va">gtfs_small</span>,</span></span>
<span class="r-in"><span>                            spatial_resolution <span class="op">=</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>                            parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fleet data, using Brazilian emission model and fleet</span></span></span>
<span class="r-in"><span><span class="va">fleet_data_ef_cetesb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>veh_type <span class="op">=</span> <span class="st">"BUS_URBAN_D"</span>,</span></span>
<span class="r-in"><span>                                   model_year <span class="op">=</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2019</span>,</span></span>
<span class="r-in"><span>                                   fuel <span class="op">=</span> <span class="st">"D"</span>,</span></span>
<span class="r-in"><span>                                   fleet_composition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span>                                   <span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Emission model</span></span></span>
<span class="r-in"><span><span class="va">emi_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="emission_model.html">emission_model</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>                tp_model <span class="op">=</span> <span class="va">tp_model</span>,</span></span>
<span class="r-in"><span>                ef_model <span class="op">=</span> <span class="st">"ef_brazil_cetesb"</span>,</span></span>
<span class="r-in"><span>                fleet_data <span class="op">=</span> <span class="va">fleet_data_ef_cetesb</span>,</span></span>
<span class="r-in"><span>                pollutant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CO"</span>,<span class="st">"PM10"</span>,<span class="st">"CO2"</span>,<span class="st">"CH4"</span>,<span class="st">"NOx"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># create spatial grid</span></span></span>
<span class="r-in"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  x <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="va">emi_list</span><span class="op">$</span><span class="va">tp_model</span><span class="op">)</span></span></span>
<span class="r-in"><span>  , cellsize <span class="op">=</span> <span class="fl">0.25</span> <span class="op">/</span> <span class="fl">200</span></span></span>
<span class="r-in"><span>  , crs<span class="op">=</span> <span class="fl">4326</span></span></span>
<span class="r-in"><span>  , what <span class="op">=</span> <span class="st">"polygons"</span></span></span>
<span class="r-in"><span>  , square <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">emi_grid</span> <span class="op">&lt;-</span> <span class="fu">emis_grid</span><span class="op">(</span> <span class="va">emi_list</span>,<span class="va">grid</span>,<span class="st">'day'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">emi_grid</span><span class="op">[</span><span class="st">"PM10_2010"</span><span class="op">]</span>,add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">emi_list</span><span class="op">$</span><span class="va">tp_model</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>,col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Converting shapes to sf objects</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Processing the data</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘data.table’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:purrr’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     transpose</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> udunits database from /usr/share/xml/udunits/udunits2.xml</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Constant emission factor along the route</span>
<span class="r-plt img"><img src="emis_grid-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Joao Bazzo, Rafael H. M. Pereira, Pedro R. Andrade, Ipea - Institute for Applied Economic Research.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

