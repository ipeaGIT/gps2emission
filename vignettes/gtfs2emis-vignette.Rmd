---
title: 'Introduction to gtfs2emis'
author: "Joao Bazzo, Rafael H. M. Pereira, Pedro R. Andrade"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
abstract: "Package `gtfs2emis` generates emission estimates for public transport networks based on GTFS data."
urlcolor: blue
vignette: |
  %\VignetteIndexEntry{Introduction to gtfs2emis} 
  %\VignetteEngine{knitr::rmarkdown} 
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

# Introduction

The package `gtfs2emis` estimates hot exhaust emissions for public transport systems based on GTFS data. This vignette introduces the main functions of the package. Here are the following packages we will use:

```{r, message = FALSE}
library(data.table)
library(sf)
library(units)
library(magrittr)
library(ggplot2)
library(mapview)
library(gtfs2gps)
library(gtfstools)
```

# Installation

You can install `gtfs2emis`:

```{r, message = FALSE}
# # From CRAN
# install.packages("gtfs2emis")
# library(gtfs2emis)
# 
# # or use the development version with latest features
# utils::remove.packages('gtfs2emis')
# devtools::install_github("ipeaGIT/gtfs2emis")
# library(gtfs2emis)
```
# Approach

The package has two main approaches:

**1. Basic usage**

- It is divided into `transport_model()` and `emissions_model()` functions
- Uses several default approaches for hot exhaust emissions inventory
- Considers the fleet to be homogeneously distributed across the vehicle routes
- Emissions inventory is straightforward, making it more friendly for unexperienced users

**2. Detailed usage**

- It uses step-by-step functions to produce the transport model: User can specific any correction on speeds distribution or routes.
- Allocation of specific vehicle into predefined routes, e.g. Articulated buses into the specific shape_id's
- Scaling non-speed dependent emission factor database with Environmental European Agency methodology


## Basic Usage

Reads GTFS

```{r, message = FALSE}
gtfs <- read_gtfs(system.file("extdata/poa.zip", package="gtfs2gps")) %>%
  filter_week_days() %>%
  filter_by_shape_id(.,"176-1") %>% 
  filter_single_trip()
```


Generate the transport model

```{r, message = FALSE}
sf_line <- transport_model(gtfs = gtfs,parallel = TRUE)
```

Create a file with fleet data, which can be imported from external file. In this example the data is organized according to the `ef_emep_europe()` emission factor data.

```{r, message = FALSE}
fleet_data_ef_europe <- data.table::data.table("veh_type" = c("Ubus Midi <=15 t"
                                                              ,"Ubus Std 15 - 18 t"
                                                              ,"Ubus Artic >18 t")
                                               ,"euro" = c("III","IV","V")
                                               ,"fuel" = rep("D",3)
                                               ,"tech" = c("-","SCR","SCR")
                                               ,"fleet_composition" = c(0.4,0.5,0.1))
```

Generate the emission model
```{r, message = FALSE}
sf_emis <- emission_model(gps = sf_line
                          ,ef_data_base = "emep_europe"
                          ,fleet_data = fleet_data_ef_europe
                          ,pollutant = c("CO","PM10","CO2","CH4","NOx"))
```

### Post process data
Results according to time

```{r, message = FALSE}
sf_emis$time_column <- sf_emis$gps$timestamp

names(sf_emis)
my_emis_summary <- emis_summary(emi_list = sf_emis,
                    emi_var = "emi", 
                    by = "time", 
                    time_column = "time_column",
                    veh_var = "veh_type", 
                    pol_var = "pollutant") 
my_emis_summary
```
Visualize results by vehicle type
```{r, message = FALSE}
my_emis_summary <- emis_summary(emi_list = sf_emis,
                                 emi_var = "emi", 
                                 by = "veh_type", 
                                 time_column = "time_column",
                                 veh_var = "veh_type", 
                                 pol_var = "pollutant") 
my_emis_summary
```
If available in `names(sf_emis)` you can add extra argument about fleet.
```{r, message = FALSE}
my_emis_summary <- emis_summary(emi_list = sf_emis,
                                emi_var = "emi", 
                                by = "veh_type", 
                                time_column = "time_column",
                                veh_var = c("veh_type","euro","fuel"),
                                pol_var = "pollutant") 
my_emis_summary
```
Viewing results by pollutant
```{r, message = FALSE}
my_emis_summary <- emis_summary(emi_list = sf_emis,
                                 emi_var = "emi", 
                                 by = "pollutant", 
                                 time_column = "time_column",
                                 veh_var = "veh_type", 
                                 pol_var = "pollutant") 
my_emis_summary
```
If user just wanted to check results in data.table format
```{r, message = FALSE}
sf_emis$time_column <- sf_emis$gps$timestamp
my_emis_dt <- emi_to_dt(emi_list = sf_emis
                    ,emi_vars = "emi"
                    ,veh_vars = c("veh_type","euro","fuel")
                    ,pol_vars =  "pollutant"
                    ,segment_vars = "time_column")
head(my_emis_dt,5)
```

To visualize emissions spatially, user should provide info about the desired grid. Here, we use `vein::make_grid()` to produce a basic grid.

```{r, message = FALSE}
grid_gps <- vein::make_grid(spobj = sf_emis$gps, width =  0.25 / 102.47) # 500 meters
grid_gps <- sf::st_as_sf(grid_gps)
```

```{r, message = FALSE}
names(sf_emis$emi)
# we add info of emissions into gps file
sf_emis$gps <- cbind(sf_emis$gps,sf_emis$emi)

pol_grid <- emis_grid(data = sf_emis$gps,
                     emi = c("CO_Euro_IV"),
                     grid = grid_gps,
                     time_class = 'all periods')
plot(pol_grid["CO_Euro_IV"])
mapview::mapview(pol_grid["CO_Euro_IV"])
```

```{r, message = FALSE}
```
```{r, message = FALSE}
```

## Detailed Usage



