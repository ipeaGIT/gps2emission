---
title: 'Introduction to gtfs2emis'
author: "Joao Bazzo, Rafael H. M. Pereira, Pedro R. Andrade"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
abstract: "Package `gtfs2emis` generates emission estimates for public transport networks based on GTFS data."
urlcolor: blue
vignette: |
  %\VignetteIndexEntry{Introduction to gtfs2emis} 
  %\VignetteEngine{knitr::rmarkdown} 
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

# Introduction

The package `gtfs2emis` estimates hot exhaust emissions of public transport systems based on GTFS and fleet data. This vignette introduces the main functions of the package. Here are the following packages we will use:

```{r, message = FALSE}
library(data.table)
library(sf)
library(units)
library(magrittr)
library(ggplot2)
library(mapview)
library(gtfs2gps)
library(gtfs2emis)
library(gtfstools)
```

# Installation

You can install `gtfs2emis`:

```{r, message = FALSE}
# # From CRAN
# install.packages("gtfs2emis")
# library(gtfs2emis)
# 
# # or use the development version with latest features
# utils::remove.packages('gtfs2emis')
# devtools::install_github("ipeaGIT/gtfs2emis")
# library(gtfs2emis)
```
# Approach

The package has two main usages, that will ultimately depends on user experience and desired output:

**1. Basic usage**


- Emissions inventory is straightforward, making it more friendly for newer users
- It is divided into `transport_model()` and `emissions_model()` functions
- In the `emissions_model()` user should specify the source of emission factors
- Uses several default approaches for hot exhaust emissions inventory
- Considers the fleet to be homogeneously distributed across the vehicle routes

**2. Detailed usage**

- It uses step-by-step functions to produce the transport and emissions model: User can specific any correction on speeds distribution, routes;
- Allocation of specific vehicle into predefined routes e.g. Articulated buses into the specific shape_id's;
- Adjusting emissions factors (fuel correction, scaling non-speed dependent EF with Environmental European Agency (EMEP-EEA) emissions factors, checking emission factors before using in the inventory).


## Basic Usage

**1. Read data**\
First step is to define the GTFS and the desired route to model emissions. Here we use a one example of `shape_id == "176-1"` in Porto Alegre (Brazil). Detailed functions of GTFS editing can be found in `gtfs2gps` and `gtfstools` R package.


```{r, message = FALSE}
gtfs <- read_gtfs(system.file("extdata/poa.zip", package="gtfs2gps")) %>%
  filter_week_days() %>%
  filter_by_shape_id(.,"176-1") %>% 
  filter_single_trip()
```

**2. Transport model**\
The transport model functions accepts either the gtfs data and filepath of the data. It is a function that transform the GTFS into GPS data.table like format, correct extreme or missing values of speed and transform in a sf-linestring format — the input we need to emissions estimates.

```{r, message = FALSE}
sf_line <- transport_model(gtfs = gtfs,parallel = TRUE)
```
Visualizing the transport model output for `shape_id == "176-1"` of Porto Alegre (Brazil).
```{r, message = FALSE}
head(sf_line$geometry)
plot(sf_line$geometry)
```

**3. Fleet data**\
As the transport model are generated, we advance to estimate the hot exhaust emissions.
We create a data frame with fleet information, which can be imported from an external file. There are two main key features of fleet data:

- If the user has data of fleet but do not have information on which bus is assigned to each route (e.g Articulated buses to `shape_id` `XX`, `YY` or `ZZ`), user can assign a probability distribution into the route.  If the vehicle is known (probability = 1), then only one vehicle class should be assigned. The probability sum be one.
- The fleet data needs to be organized according to the desired emission factor database. For instance, if Users wants to estimate emissions based on typical European fleet, they should present the data according the the typical emission factors inputs for Emep-EEA methodology. In this example the data is organized according to the requirements for `ef_emep_europe()` emission factor data. Users can check in `ef_moves_usa()`, `ef_emfac_usa()`, `ef_cetesb_brazil()` or `ef_emep_europe()` how the fleet should be organized.

In the example of european emission factors, we are presenting three vehicles classes. This means the a certain `shape_id` has 40\%, 50\%, and 10\% chance of having `Ubus Midi <=15 t`, `Ubus Std 15 - 18 t`, and `Ubus Artic >18 t `, respectively.  

```{r, message = FALSE}
fleet_data_ef_europe <- data.table::data.table("veh_type" = c("Ubus Midi <=15 t"
                                                              ,"Ubus Std 15 - 18 t"
                                                              ,"Ubus Artic >18 t")
                                               ,"euro" = c("III","IV","V")
                                               ,"fuel" = rep("D",3)
                                               ,"tech" = c("-","SCR","SCR")
                                               ,"fleet_composition" = c(0.4,0.5,0.1))
fleet_data_ef_europe
```
This data.table are quite similar to other emissions factors database sources: Emission Factor Model (California Air Resources Board);

```{r, message = FALSE}
fleet_data_ef_emfac <- data.table::data.table("veh_type" = "BUS_URBAN_D"
                                              ,"model_year" = 2011:2015
                                              ,"fuel" = "D"
                                              ,"calendar_year" = 2019
                                              ,"fleet_composition" = rep(0.2,5))
fleet_data_ef_emfac
```
 MOtor Vehicle Emission Simulator (MOVES) from Environmental Protection Agency (United States);
```{r, message = FALSE}
fleet_data_ef_moves <- data.table::data.table("veh_type" = "BUS_URBAN_D"
                                              ,"model_year" = 2011:2015
                                              ,"fuel" = "D"
                                              ,"calendar_year" = 2016
                                              ,"fleet_composition" = rep(0.2,5))
fleet_data_ef_moves
```

Environmental Company of São Paulo (CETESB, Brazil).
```{r, message = FALSE}
fleet_data_ef_cetesb <- data.table::data.table("veh_type" = c("BUS_MICRO_D"
                                                              ,"BUS_URBAN_D"
                                                              ,"BUS_ARTIC_D")
                                               ,"model_year" = rep(2010,3)
                                               ,"fuel" = rep("D",3)
                                               ,"fleet_composition" = c(0.4,0.4,0.2))
fleet_data_ef_cetesb
```

**4. Emissions model**\
To generate the emission results, we couple the results from `transport_model()` along with the `fleet_data` previously imported. The `emission_model` generated a list of several files of interests on emissions, which can be related to vehicle variables (`fuel`, `age`, `tech`, `euro`, `fleet_composition`), travel variables (`slope`, `load`, `gps`) or pollution (`EF`, `emi`).

```{r, message = FALSE}
sf_emis <- emission_model(gps = sf_line
                          ,ef_data_base = "emep_europe"
                          ,fleet_data = fleet_data_ef_europe
                          ,pollutant = c("CO","PM10","CO2","CH4","NOx"))
class(sf_emis)
names(sf_emis)
```

**5. Data post-processing**\
As the results are generated in a long list, gtfs2emis package has several function to post-processing the results of interest. `emis_summary` summarizes the emissions according to the variable of interest, such as vehicle type `veh_type`, `pollutant` or `time`. In this last case, we have to add a `time_column` in the list as this information is not shown by the `emission_model()` function.

```{r, message = FALSE}
sf_emis$time_column <- sf_emis$gps$timestamp

names(sf_emis)
my_emis_summary <- emis_summary(emi_list = sf_emis,
                    emi_var = "emi", 
                    by = "time", 
                    time_column = "time_column",
                    veh_var = "veh_type", 
                    pol_var = "pollutant") 
my_emis_summary
```
Visualize results by vehicle type `veh_type`
```{r, message = FALSE}
my_emis_summary <- emis_summary(emi_list = sf_emis,
                                 emi_var = "emi", 
                                 by = "veh_type", 
                                 time_column = "time_column",
                                 veh_var = "veh_type", 
                                 pol_var = "pollutant") 
my_emis_summary
```
If available in `names(sf_emis)` you can add extra argument about fleet.
```{r, message = FALSE}
my_emis_summary <- emis_summary(emi_list = sf_emis,
                                emi_var = "emi", 
                                by = "veh_type", 
                                time_column = "time_column",
                                veh_var = c("veh_type","euro","fuel"),
                                pol_var = "pollutant") 
my_emis_summary
```
Viewing results by pollutant
```{r, message = FALSE}
my_emis_summary <- emis_summary(emi_list = sf_emis,
                                 emi_var = "emi", 
                                 by = "pollutant", 
                                 time_column = "time_column",
                                 veh_var = "veh_type", 
                                 pol_var = "pollutant") 
my_emis_summary
```
If user just wanted to have all results in a data.table format
```{r, message = FALSE}
sf_emis$time_column <- sf_emis$gps$timestamp
my_emis_dt <- emi_to_dt(emi_list = sf_emis
                    ,emi_vars = "emi"
                    ,veh_vars = c("veh_type","euro","fuel")
                    ,pol_vars =  "pollutant"
                    ,segment_vars = "time_column")
head(my_emis_dt,5)
```

To visualize emissions spatially, user should provide info about the desired grid. Here, we use `vein::make_grid()` to produce a basic grid.

```{r, message = FALSE}
grid_gps <- vein::make_grid(spobj = sf_emis$gps, width =  0.25 / 102.47) # 500 meters
grid_gps <- sf::st_as_sf(grid_gps)
```

```{r, message = FALSE}
names(sf_emis$emi)
# we add info of emissions into gps file
sf_emis$gps <- cbind(sf_emis$gps,sf_emis$emi)

pol_grid <- emis_grid(data = sf_emis$gps,
                     emi = c("CO_Euro_IV"),
                     grid = grid_gps,
                     time_class = 'all periods')
plot(pol_grid["CO_Euro_IV"])
mapview::mapview(pol_grid["CO_Euro_IV"])
```

```{r, message = FALSE}
```
```{r, message = FALSE}
```

## Detailed Usage



